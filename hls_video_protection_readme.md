# ระบบป้องกันวิดีโอด้วย HLS

## ภาพรวม

โปรเจคนี้สร้างระบบป้องกันเนื้อหาวิดีโอพื้นฐานโดยใช้ HTTP Live Streaming (HLS) ร่วมกับการเข้ารหัส AES-128 และระบบการยืนยันตัวตนฝั่งเซิร์ฟเวอร์ ระบบนี้ป้องกันการดาวน์โหลดวิดีโอแบบง่ายๆ ขณะที่อนุญาตให้ผู้ใช้ที่ได้รับการยืนยันตัวตนสามารถสตรีมเนื้อหาที่ป้องกันได้

## สถาปัตยกรรมทางเทคนิค

### ส่วนประกอบหลัก

1. **การแบ่งส่วน HLS**: วิดีโอถูกแบ่งเป็นส่วนเล็กๆ (6 วินาทีต่อส่วน)
2. **การเข้ารหัส AES-128**: แต่ละส่วนถูกเข้ารหัสด้วยคีย์ 128 บิต
3. **เซิร์ฟเวอร์การยืนยันตัวตน**: ระบบยืนยันผู้ใช้แบบ JWT
4. **เซิร์ฟเวอร์คีย์ป้องกัน**: การกระจายคีย์เข้ารหัสพร้อมการควบคุมการเข้าถึง
5. **เครื่องเล่นเว็บ**: HLS player ในเบราว์เซอร์พร้อมการยืนยันตัวตน

### โมเดลความปลอดภัย

```
การยืนยันผู้ใช้ → JWT Token → การเข้าถึงเซิร์ฟเวอร์คีย์ → การถอดรหัสส่วนวิดีโอ → การเล่นวิดีโอ
```

**ระดับการป้องกัน**: การป้องกันเนื้อหาพื้นฐานที่เหมาะสำหรับเนื้อหาการศึกษาหรือการใช้งานภายใน ไม่ใช่ DRM ระดับองค์กร

## ขั้นตอนการสร้างระบบ

### ขั้นตอนที่ 1: การเตรียมวิดีโอ

```bash
# สร้างคีย์เข้ารหัส HLS
openssl rand 16 > hls_key.bin
HLS_KEY_HEX=$(xxd -p hls_key.bin | tr -d '\n')

# สร้างไฟล์ข้อมูลคีย์สำหรับ FFmpeg
cat > hls_keyinfo.txt << EOF
http://localhost:8001/hlskey
hls_key.bin
$HLS_KEY_HEX
EOF

# แปลงวิดีโอเป็น HLS ที่เข้ารหัส
ffmpeg -i input_video.mp4 \
       -c:v libx264 -c:a aac \
       -hls_time 6 \
       -hls_key_info_file hls_keyinfo.txt \
       -hls_playlist_type vod \
       -hls_segment_filename 'hls_seg%03d.ts' \
       encrypted_hls.m3u8
```

**ไฟล์ที่ได้:**
- `encrypted_hls.m3u8`: HLS playlist ที่มีรายการส่วนวิดีโอและข้อมูลการเข้ารหัส
- `hls_seg000.ts`, `hls_seg001.ts`, เป็นต้น: ส่วนวิดีโอที่เข้ารหัสแล้ว
- `hls_key.bin`: คีย์เข้ารหัส 128 บิต

### ขั้นตอนที่ 2: เซิร์ฟเวอร์การยืนยันตัวตน

เซิร์ฟเวอร์ API ที่สร้างด้วย Flask ให้บริการ:

```python
POST /login          # การยืนยันผู้ใช้ → JWT token
GET  /playlist       # HLS playlist (ต้องมีการยืนยันตัวตน)
GET  /hlskey         # คีย์เข้ารหัส (ต้องมีการยืนยันตัวตน)
GET  /<filename>     # ส่วนวิดีโอ (เปิดให้ทุกคน)
```

**กระบวนการยืนยันตัวตน:**
1. Client ส่ง username/password ไปที่ `/login`
2. Server ตรวจสอบข้อมูลและส่งคืน JWT token
3. Client ใช้ token ในการร้องขอต่อไป
4. Server ตรวจสอบ token ก่อนให้บริการทรัพยากรที่ป้องกัน

### ขั้นตอนที่ 3: การรวมเครื่องเล่นเว็บ

HLS.js player พร้อม request interceptor:

```javascript
hls = new Hls({
    xhrSetup: function(xhr, url) {
        if (url.includes('localhost:8001')) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        }
    }
});
```

## หลักการทำงาน

### กลไกการป้องกันเนื้อหา

1. **การแบ่งส่วน**: วิดีโอต้นฉบับถูกแบ่งเป็นส่วนย่อย 6 วินาที
2. **การเข้ารหัส**: แต่ละส่วนถูกเข้ารหัสด้วย AES-128
3. **การกระจายคีย์**: คีย์เข้ารหัสให้บริการแยกต่างหากพร้อมการยืนยันตัวตน
4. **การถอดรหัสในเบราว์เซอร์**: HLS.js ดาวน์โหลดส่วนต่างๆ และถอดรหัสในหน่วยความจำ

### ขั้นตอนการร้องขอ

```
1. เข้าสู่ระบบผู้ใช้ → JWT Token
2. ร้องขอ Playlist → Server ตรวจสอบ token → ส่งคืน encrypted_hls.m3u8
3. Player อ่าน playlist → ค้นพบส่วนที่เข้ารหัสและ URL คีย์
4. ร้องขอคีย์ → Server ตรวจสอบ token → ส่งคืนคีย์เข้ารหัส
5. ดาวน์โหลดส่วนต่างๆ → ถอดรหัสด้วยคีย์ → เล่นวิดีโอ
```

### โครงสร้าง Playlist

```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:7
#EXT-X-KEY:METHOD=AES-128,URI="http://localhost:8001/hlskey"
#EXTINF:6.0,
hls_seg000.ts
#EXTINF:6.0,
hls_seg001.ts
#EXT-X-ENDLIST
```

## การรันระบบ

### ข้อกำหนดเบื้องต้น

```bash
brew install ffmpeg python3
pip install flask flask-cors pyjwt
```

### การเริ่มต้นระบบ

```bash
# Terminal 1: API Server
python streaming_server.py

# Terminal 2: Web Server  
python -m http.server 8000
```

### การเข้าถึง

- เครื่องเล่นเว็บ: `http://localhost:8000/hls_player.html`
- ข้อมูลเข้าสู่ระบบเริ่มต้น: `demo` / `demo123`

## ข้อพิจารณาด้านความปลอดภัย

### ความสามารถในการป้องกัน

- **ป้องกันได้**: การดาวน์โหลดไฟล์วิดีโอโดยตรง
- **ป้องกันได้**: การคัดลอกเนื้อหาแบบง่ายๆ
- **ป้องกันได้**: การเข้าถึงโดยไม่ได้รับอนุญาตโดยไม่มีข้อมูลรับรอง

### ข้อจำกัด

- **การมองเห็นคีย์**: คีย์เข้ารหัสถูกส่งไปยัง client (มองเห็นได้ในการจราจรเครือข่าย)
- **การประกอบใหม่**: ผู้ใช้ที่มีความรู้ทางเทคนิคสามารถประกอบส่วนต่างๆ ใหม่ได้
- **การบันทึกหน้าจอ**: ไม่สามารถป้องกันการจับภาพหน้าจอได้
- **การจัดเก็บในเบราว์เซอร์**: ส่วนต่างๆ อาจถูก cache ไว้ในเครื่อง

### โมเดลภัยคุกคาม

การใช้งานนี้ป้องกันต่อ:
- ผู้ใช้ทั่วไปที่พยายามดาวน์โหลดไฟล์วิดีโอ
- การเข้าถึงโดยไม่ได้รับอนุญาตโดยไม่มีข้อมูลเข้าสู่ระบบ
- เครื่องมือขูดเนื้อหาแบบง่าย

ไม่สามารถป้องกันต่อ:
- ผู้ใช้ที่มีความตั้งใจและความรู้ทางเทคนิค
- ซอฟต์แวร์บันทึกหน้าจอ
- การวิเคราะห์การจราจรเครือข่าย
- เครื่องมือสกัดเนื้อหาขั้นสูง

## ข้อพิจารณาสำหรับการใช้งานจริง

### ข้อกำหนดการขยายระบบ

- **การรวม CDN**: กระจายส่วนต่างๆ ผ่าน CDN ขณะที่รักษาเซิร์ฟเวอร์คีย์ไว้ส่วนกลาง
- **ฐานข้อมูลแบ็กเอนด์**: แทนที่การจัดเก็บผู้ใช้ในหน่วยความจำ
- **การจัดการเซสชัน**: ใช้งานการรีเฟรช token และการเพิกถอนอย่างเหมาะสม
- **การหมุนคีย์**: การอัปเดตคีย์เป็นระยะเพื่อเพิ่ความปลอดภัย

### ทางเลือกระดับองค์กร

สำหรับเนื้อหาที่มีค่าสูงที่ต้องการการป้องกันที่แข็งแกร่งกว่า:

- **Widevine DRM**: การป้องกันระดับฮาร์ดแวร์
- **PlayReady**: ระบบ DRM ของ Microsoft  
- **FairPlay**: ระบบ DRM ของ Apple
- **Multi-DRM Solutions**: บริการผู้ให้บริการ DRM แบบรวม

## โครงสร้างไฟล์

```
├── encrypted_hls.m3u8      # HLS playlist
├── hls_seg000.ts           # ส่วนวิดีโอที่เข้ารหัส
├── hls_seg001.ts
├── hls_seg002.ts
├── hls_key.bin            # คีย์เข้ารหัส
├── hls_keyinfo.txt        # การกำหนดค่าคีย์
├── hls_player.html        # เครื่องเล่นเว็บ
├── streaming_server.py    # เซิร์ฟเวอร์ API
└── test_video.mp4         # วิดีโอต้นฉบับ
```

## เทคโนโลยีที่ใช้

- **การประมวลผลวิดีโอ**: FFmpeg
- **โปรโตคอลสตรีม**: HTTP Live Streaming (HLS)
- **การเข้ารหัส**: AES-128
- **การยืนยันตัวตน**: JWT tokens
- **แบ็กเอนด์**: Flask (Python)
- **ฟรอนต์เอนด์**: HLS.js
- **การขนส่ง**: HTTP/HTTPS

## ลักษณะประสิทธิภาพ

- **ความล่าช้า**: 15-30 วินาที (การบัฟเฟอร์ HLS มาตรฐาน)
- **แบนด์วิธ**: ปรับเปลี่ยนตามสภาพเครือข่าย
- **ความเข้ากันได้**: เบราว์เซอร์สมัยใหม่ที่รองรับ HLS.js
- **การขยายระบบ**: ดี (ส่วนต่างๆ สามารถ cache ได้, เซิร์ฟเวอร์คีย์มีน้ำหนักเบา)